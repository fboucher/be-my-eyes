name: Publish to Homebrew

on:
  workflow_run:
    workflows: ["Build macOS"]
    types: [completed]

permissions:
  contents: read

jobs:
  publish-brew:
    name: Update Homebrew tap
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          # Get the most recent version tag
          TAG=$(git tag --list 'v*.*.*' --sort=-version:refname --merged HEAD | head -n 1)
          if [ -z "$TAG" ]; then
            echo "ERROR: No version tag found"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"

      - name: Download release artifacts and calculate checksums
        id: checksums
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          VERSION="${TAG#v}"
          
          # Download and calculate checksums
          echo "Downloading release artifacts..."
          
          curl -sL "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_darwin_arm64.tar.gz" -o darwin_arm64.tar.gz
          curl -sL "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_darwin_amd64.tar.gz" -o darwin_amd64.tar.gz
          curl -sL "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_linux_arm64.tar.gz" -o linux_arm64.tar.gz
          curl -sL "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_linux_amd64.tar.gz" -o linux_amd64.tar.gz
          
          DARWIN_ARM64_SHA=$(shasum -a 256 darwin_arm64.tar.gz | cut -d ' ' -f 1)
          DARWIN_AMD64_SHA=$(shasum -a 256 darwin_amd64.tar.gz | cut -d ' ' -f 1)
          LINUX_ARM64_SHA=$(shasum -a 256 linux_arm64.tar.gz | cut -d ' ' -f 1)
          LINUX_AMD64_SHA=$(shasum -a 256 linux_amd64.tar.gz | cut -d ' ' -f 1)
          
          echo "darwin_arm64_sha=${DARWIN_ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "darwin_amd64_sha=${DARWIN_AMD64_SHA}" >> $GITHUB_OUTPUT
          echo "linux_arm64_sha=${LINUX_ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "linux_amd64_sha=${LINUX_AMD64_SHA}" >> $GITHUB_OUTPUT
          
          echo "Checksums calculated:"
          echo "  darwin_arm64: ${DARWIN_ARM64_SHA}"
          echo "  darwin_amd64: ${DARWIN_AMD64_SHA}"
          echo "  linux_arm64: ${LINUX_ARM64_SHA}"
          echo "  linux_amd64: ${LINUX_AMD64_SHA}"

      - name: Update Homebrew formula
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          VERSION="${TAG#v}"
          
          # Clone the tap repository
          git clone https://oauth2:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/fboucher/homebrew-tap.git tap
          cd tap
          
          # Update the formula
          cat > be-my-eyes.rb << EOF
          class BeMyEyes < Formula
            desc "A Terminal User Interface (TUI) for analyzing/ summarizing/ questioning / searching into videos using AI"
            homepage "https://github.com/fboucher/be-my-eyes"
            version "${VERSION}"
            license "MIT"
          
            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_darwin_arm64.tar.gz"
                sha256 "${{ steps.checksums.outputs.darwin_arm64_sha }}"
              else
                url "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_darwin_amd64.tar.gz"
                sha256 "${{ steps.checksums.outputs.darwin_amd64_sha }}"
              end
            end
          
            on_linux do
              if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
                url "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_linux_arm64.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_arm64_sha }}"
              else
                url "https://github.com/fboucher/be-my-eyes/releases/download/${TAG}/be-my-eyes_${VERSION}_linux_amd64.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_amd64_sha }}"
              end
            end
          
            def install
              bin.install "be-my-eyes"
            end
          
            test do
              system "#{bin}/be-my-eyes", "--version"
            end
          end
          EOF
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add be-my-eyes.rb
          git commit -m "Update be-my-eyes to ${VERSION}" || echo "No changes to commit"
          git push
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
