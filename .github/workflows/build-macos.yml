name: Build macOS

on:
  workflow_run:
    workflows: ["Build Linux"]
    types: [completed]

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS binaries
    runs-on: macos-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag from recent push
        id: tag
        run: |
          # Get the most recent version tag on main branch
          TAG=$(git tag --list 'v*.*.*' --sort=-version:refname --merged HEAD | head -n 1)
          if [ -z "$TAG" ]; then
            echo "ERROR: No version tag found"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build macOS binaries with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: build --config .goreleaser-macos.yml --skip=validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release ID
        id: get_release
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          echo "Looking up release for tag ${TAG}"
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}")
          RELEASE_ID=$(echo "$RELEASE_JSON" | python -c 'import sys, json; print(json.load(sys.stdin).get("id") or "")')
          if [ -z "$RELEASE_ID" ]; then
            echo "ERROR: Release not found for tag ${TAG}"
            exit 1
          fi
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Release ID: $RELEASE_ID"

      - name: Upload macOS artifacts to release
        run: |
          RELEASE_ID=${{ steps.get_release.outputs.release_id }}
          REPO="${{ github.repository }}"
          echo "Uploading macOS binaries to release ${RELEASE_ID}"
          echo "Looking for artifacts in dist/"
          ls -la dist/ || echo "dist/ directory not found"
          for f in dist/*darwin*/*.tar.gz; do
            [ -f "$f" ] || continue
            NAME=$(basename "$f")
            echo "Uploading $NAME"
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$f" \
              "https://uploads.github.com/repos/${REPO}/releases/${RELEASE_ID}/assets?name=${NAME}")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
              echo "✓ Successfully uploaded $NAME (HTTP $HTTP_CODE)"
            else
              echo "✗ Failed to upload $NAME (HTTP $HTTP_CODE)"
              echo "Response: $BODY"
              exit 1
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
